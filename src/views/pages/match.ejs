<%- include('../partials/header', { pageTitle: 'Match | PolyCOOP' }) %>
       
        <main>
            <div class="center-content">
            <% if (users && users.length > 0) { %>
            <div class="match-card">
                <a href="profile/<%= users[0].userSlug %>">
                <div class="card-details">
                    <img src="uploads/<%= users[0].profileImage %>" alt="Profile Image" class="card-image">
                    <div class="card-info">
                    <p class="card-username"><%= users[0].username %></p>
                    <p><%= users[0].age %> years old</p>
                    <p><%= users[0].description %></p>
                    </div>
                </div>
                </a>
                <div class="card-buttons">
                    <button class="skip-btn" onclick="skipProfile()"><img src="/img/skip.png" class="skip-btn-decoration"> Skip</button>
                    <button class="match-btn" onclick="matchProfile()"><img src="/img/logowhite.png" class="match-btn-decoration"> Match</button>
                </div>
            </div>
            <% } else { %>
                <div class="no-users">
                    <img src="/img/error.png" class="error-image"><br>
                    <h2>No available profiles!</h2><br>
                    <a href="/" class="secondary-btn-blk">Return to homepage</a>
                </div>
            <% } %>
            </div>
        </main>

        <%- include('../partials/footer') %>

       <script>
    let currentIndex = 0;
    const allUsers = <%- JSON.stringify(users) %>;

    function sendMatchRequest(userId) {
        fetch('/match', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ matchedUserId: userId })
        })
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                console.error('Error recording match');
            }
        })
        .catch(console.error);
    }

    function showNoUsers() {
        const center = document.querySelector('.center-content');
        center.innerHTML = `
            <div class="no-users">
                <img src="/img/error.png" class="error-image"><br>
                <h2>No available profiles!</h2><br>
                <a href="/" class="secondary-btn-blk">Return to homepage</a>
            </div>
        `;
    }

    function loadProfile() {
        const user = allUsers[currentIndex];
        const card = document.querySelector('.match-card');

        if (!user || !card) return;

        card.querySelector('a').href = `profile/${user.userSlug}`;
        card.querySelector('.card-image').src = `uploads/${user.profileImage}`;
        card.querySelector('.card-image').alt = `${user.username}'s profile image`;

        card.querySelector('.card-username').textContent = user.username;
        card.querySelector('.card-info p:nth-child(2)').textContent = `${user.age} years old`;
        card.querySelector('.card-info p:nth-child(3)').textContent = user.description;
    }

    function matchProfile() {
        if (currentIndex < allUsers.length) {
            sendMatchRequest(allUsers[currentIndex]._id);
            currentIndex++;

            currentIndex < allUsers.length
                ? loadProfile()
                : showNoUsers();
        }
    }

    function skipProfile() {
        currentIndex++;

        currentIndex < allUsers.length
            ? loadProfile()
            : showNoUsers();
    }
</script>
